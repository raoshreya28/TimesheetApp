<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timesheet App</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        
        <div class="d-flex justify-content-between mb-3">
            <h2>MY TIMESHEETS</h2>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>

        
        <form id="timesheetForm" class="mb-4">
            
            <input type="hidden" id="timesheetId">

            <div class="row g-2">
                <div class="col-md-3">
                    <input type="date" id="date" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <input type="number" id="hours" class="form-control" placeholder="Hours Worked" required>
                </div>

                
                <div class="col-md-4">
                    <input type="text" id="description" class="form-control" placeholder="Description">
                </div>

               
                <div class="col-md-2">
                    <button type="submit" id="formBtn" class="btn btn-primary w-100">Add</button>
                </div>
            </div>
        </form>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Hours Worked</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
           
            <tbody id="timesheetTable"></tbody>
        </table>
    </div>

    <script>
        // Get employeeId 
        const employeeId = localStorage.getItem("employeeId");
        if (!employeeId) window.location.href = "login.html"; 

        const form = document.getElementById("timesheetForm");
        const table = document.getElementById("timesheetTable");
        let editing = false; 

        // Load all timesheets for logged in employee
        async function loadTimesheets() {
            const res = await fetch(`https://localhost:7093/api/timesheet/employee/${employeeId}`);
            if (!res.ok) return alert("Failed to load timesheets");

            const data = await res.json();
            table.innerHTML = "";

            // Add each timesheet row to the table
            data.forEach(t => {
                table.innerHTML += `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${t.hoursWorked}</td>
                        <td>${t.description || ""}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit" data-id="${t.id}">Edit</button>
                            <button class="btn btn-sm btn-danger delete" data-id="${t.id}">Delete</button>
                        </td>
                    </tr>`;
            });
        }

       
        form.addEventListener("submit", async e => {
            e.preventDefault();

           
            const payload = {
                date: document.getElementById("date").value,
                hoursWorked: parseFloat(document.getElementById("hours").value),
                description: document.getElementById("description").value,
                employeeId: parseInt(employeeId)
            };

          
            let url = "https://localhost:7093/api/timesheet";
            let method = "POST";

           
            const id = document.getElementById("timesheetId").value;
            if (editing) {
                url += `/${id}`;
                method = "PUT";
            }

            // Send request to API
            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) return alert("Failed to save timesheet");

            // Reset form after success
            form.reset();
            editing = false;
            document.getElementById("formBtn").textContent = "Add";

            // Reload updated list
            loadTimesheets();
        });

       
        table.addEventListener("click", async e => {
            const btn = e.target;
            const id = btn.dataset.id;
            if (!id) return;

            // Delete timesheet
            if (btn.classList.contains("delete")) {
                if (confirm("Delete this timesheet?")) {
                    const res = await fetch(`https://localhost:7093/api/timesheet/${id}`, { method: "DELETE" });
                    if (!res.ok) return alert("Failed to delete timesheet");
                    loadTimesheets();
                }
            }
            // Edit timesheet
            else if (btn.classList.contains("edit")) {
                const res = await fetch(`https://localhost:7093/api/timesheet/${id}`);
                if (!res.ok) return alert("Failed to fetch timesheet");

                const t = await res.json();

               
                document.getElementById("date").value = t.date.substring(0, 10);
                document.getElementById("hours").value = t.hoursWorked;
                document.getElementById("description").value = t.description;
                document.getElementById("timesheetId").value = id;

                editing = true;
                document.getElementById("formBtn").textContent = "Update";
            }
        });

        // Handle logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("employeeId"); // Clear login info
            window.location.href = "login.html";  // Redirect to login page
        });

        loadTimesheets();
    </script>
</body>
</html>
